<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>急診月曆排班工具 - 修訂版</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .modal-hidden { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .modal-visible { display: flex; opacity: 1; }
        
        /* 修訂後的班次顏色 */
        .shift-color-day { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .shift-color-evening { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .shift-color-night { background: linear-gradient(135deg, #1f2937, #111827); color: white; }
        .shift-color-weekend-day { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .shift-color-weekend-night { background: linear-gradient(135deg, #7c3aed, #5b21b6); color: white; }
        .shift-color-off { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

        .calendar-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        .calendar-header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 1.5rem;
        }

        .date-cell {
            position: relative;
            border: 1px solid #e2e8f0;
            min-height: 120px;
            transition: all 0.2s ease;
        }

        .date-cell:hover {
            background-color: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .today-cell {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 2px solid #3b82f6;
        }

        .other-month-cell {
            background-color: #f8fafc;
            min-height: 120px;
            opacity: 0.5;
        }

        .other-month-cell .date-number {
            color: #9ca3af !important;
        }

        .holiday-cell {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
        }

        .weekend-cell {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
        }

        .date-number {
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin: 4px;
        }

        .today-number {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .holiday-number {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .weekend-number {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }

        .shift-item {
            margin: 2px 0;
            padding: 3px 6px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 500;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .shift-item:hover {
            transform: scale(1.05);
        }

        .weekday-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 12px;
        }

        .conflict-cell {
            border: 2px solid #ef4444 !important;
            background-color: #fef2f2 !important;
            animation: pulse 2s infinite;
        }

        .conflict-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            z-index: 10;
            animation: bounce 1s infinite;
        }

        .conflict-tooltip {
            visibility: hidden;
            width: max-content;
            max-width: 250px;
            background: #374151;
            color: white;
            text-align: left;
            border-radius: 8px;
            padding: 10px;
            position: absolute;
            z-index: 20;
            bottom: 105%;
            right: 0;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
        }

        .conflict-indicator:hover .conflict-tooltip {
            visibility: visible;
            opacity: 1;
        }

        .unavailable-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: #f59e0b;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            z-index: 5;
        }

        .unavailable-cell {
            background-color: #fef3c7 !important;
        }

        .holiday-indicator {
            position: absolute;
            top: 2px;
            right: 28px;
            width: 16px;
            height: 16px;
            background: #f59e0b;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            z-index: 5;
        }

        .weekend-indicator {
            position: absolute;
            top: 2px;
            right: 44px;
            width: 16px;
            height: 16px;
            background: #0ea5e9;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            z-index: 5;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-5px,0); }
            70% { transform: translate3d(0,-3px,0); }
            90% { transform: translate3d(0,-1px,0); }
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .availability-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 16px;
        }

        .availability-day {
            aspect-ratio: 1;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .availability-day:hover {
            transform: scale(1.05);
        }

        .availability-available {
            background: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }

        .availability-unavailable {
            background: #fef2f2;
            border-color: #dc2626;
            color: #dc2626;
        }

        .availability-neutral {
            background: #f9fafb;
            color: #6b7280;
        }

        .employee-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .employee-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .notification-success { background: #059669; }
        .notification-error { background: #dc2626; }
        .notification-warning { background: #d97706; }
        .notification-info { background: #0ea5e9; }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-white mb-4">急診月曆排班工具</h1>
            <p class="text-xl text-white opacity-90">週一至五三班制，週六日及假日兩班制</p>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <aside class="xl:col-span-1">
                <div class="glass-effect rounded-2xl p-6 text-white">
                    <h2 class="text-2xl font-bold mb-6 text-center">控制面板</h2>
                    
                    <!-- 員工管理 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5"></i>員工管理
                        </h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="employeeNameInput" placeholder="輸入員工姓名" 
                                   class="flex-grow px-3 py-2 text-gray-800 bg-white border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300">
                            <button id="addEmployeeBtn" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all flex items-center gap-1">
                                <i data-lucide="user-plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="employeeList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                    </div>

                    <!-- 假日班設定 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-5 h-5"></i>假日班設定
                        </h3>
                        <button id="openHolidayModalBtn" 
                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                            <i data-lucide="sun" class="w-4 h-4"></i>設定假日班
                        </button>
                    </div>

                    <!-- 快速操作 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="zap" class="w-5 h-5"></i>快速操作
                        </h3>
                        <div class="space-y-3">
                            <button id="openAvailabilityModalBtn" 
                                    class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                                <i data-lucide="calendar-check" class="w-4 h-4"></i>員工約班
                            </button>
                            <button id="openConditionsModalBtn" 
                                    class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i>排班條件
                            </button>
                            <button id="autoScheduleBtn" 
                                    class="w-full bg-violet-500 hover:bg-violet-600 text-white px-4 py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                                <i data-lucide="wand-2" class="w-4 h-4"></i>自動排班
                            </button>
                            <button id="validateScheduleBtn" 
                                    class="w-full bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                                <i data-lucide="shield-check" class="w-4 h-4"></i>檢查衝突
                            </button>
                            <button id="generateReportBtn" 
                                    class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                                <i data-lucide="file-text" class="w-4 h-4"></i>統計報表
                            </button>
                        </div>
                    </div>

                    <!-- 資料管理 -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="database" class="w-5 h-5"></i>資料管理
                        </h3>
                        <div class="space-y-3">
                            <button id="exportDataBtn" 
                                    class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i>匯出資料
                            </button>
                            <label for="importDataInput" 
                                   class="w-full bg-amber-500 hover:bg-amber-600 text-white px-4 py-3 rounded-lg transition-all cursor-pointer flex items-center justify-center gap-2">
                                <i data-lucide="upload" class="w-4 h-4"></i>匯入資料
                            </label>
                            <input type="file" id="importDataInput" class="hidden" accept=".json">
                        </div>
                    </div>
                </div>
            </aside>

            <!-- 主日曆 -->
            <main class="xl:col-span-3">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="flex items-center justify-between mb-4">
                            <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-white/20 transition-all">
                                <i data-lucide="chevron-left" class="w-6 h-6"></i>
                            </button>
                            <div class="flex gap-4">
                                <select id="yearSelect" class="bg-white/20 text-white border border-white/30 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white/50"></select>
                                <select id="monthSelect" class="bg-white/20 text-white border border-white/30 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white/50"></select>
                            </div>
                            <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-white/20 transition-all">
                                <i data-lucide="chevron-right" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div id="monthlyStats" class="text-center text-white/90"></div>
                    </div>
                    
                    <!-- 星期標題 -->
                    <div class="grid grid-cols-7">
                        <div class="weekday-header">日</div>
                        <div class="weekday-header">一</div>
                        <div class="weekday-header">二</div>
                        <div class="weekday-header">三</div>
                        <div class="weekday-header">四</div>
                        <div class="weekday-header">五</div>
                        <div class="weekday-header">六</div>
                    </div>
                    
                    <!-- 日期格子 -->
                    <div id="calendarDateGrid" class="grid grid-cols-7"></div>
                    
                    <!-- 圖例 -->
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color shift-color-day"></div><span>平日白班 (7:00-15:00)</span></div>
                        <div class="legend-item"><div class="legend-color shift-color-evening"></div><span>平日小夜 (15:00-23:00)</span></div>
                        <div class="legend-item"><div class="legend-color shift-color-night"></div><span>平日大夜 (23:00-7:00)</span></div>
                        <div class="legend-item"><div class="legend-color shift-color-weekend-day"></div><span>週末/假日白班 (7:00-19:00)</span></div>
                        <div class="legend-item"><div class="legend-color shift-color-weekend-night"></div><span>週末/假日夜班 (19:00-7:00)</span></div>
                        <div class="legend-item"><div class="legend-color shift-color-off"></div><span>休假</span></div>
                        <div class="legend-item"><div class="w-4 h-4 bg-amber-200 rounded border-2 border-amber-400"></div><span>有員工不可用</span></div>
                        <div class="legend-item"><div class="w-4 h-4 bg-yellow-300 rounded border-2 border-yellow-500"></div><span>假日班</span></div>
                        <div class="legend-item"><div class="w-4 h-4 bg-blue-200 rounded border-2 border-blue-400"></div><span>週末</span></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 假日班設定 Modal -->
    <div id="holidayModal" class="modal-hidden fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl p-6 relative flex flex-col max-h-[90vh]">
            <button id="closeHolidayModalBtn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors">
                <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-2">
                <i data-lucide="sun" class="w-6 h-6 text-yellow-500"></i>假日班設定
            </h3>
            
            <div class="flex gap-6 mb-6">
                <div class="flex-shrink-0">
                    <label class="block text-sm font-medium text-gray-700 mb-2">選擇月份</label>
                    <div class="flex gap-2">
                        <select id="holidayYearSelect" class="w-24 p-3 border rounded-lg"></select>
                        <select id="holidayMonthSelect" class="w-24 p-3 border rounded-lg"></select>
                    </div>
                </div>
                <div class="flex items-end gap-2">
                    <button id="clearHolidaysBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition-colors">清空假日</button>
                    <button id="setWeekendsHolidayBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg transition-colors">設定周末為假日</button>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto">
                <div id="holidayCalendarContainer" class="mb-6">
                    <p class="text-gray-500 text-center py-8">請先選擇月份</p>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2 text-gray-700">假日班說明</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 點擊日期可切換假日狀態</li>
                        <li>• <span class="text-yellow-600 font-semibold">黃色</span>：假日班（兩班制：白班7:00-19:00，夜班19:00-7:00）</li>
                        <li>• <span class="text-blue-600 font-semibold">藍色</span>：週末（自動兩班制：白班7:00-19:00，夜班19:00-7:00）</li>
                        <li>• <span class="text-gray-500 font-semibold">灰色</span>：平日班（三班制：白班7:00-15:00，小夜15:00-23:00，大夜23:00-7:00）</li>
                        <li>• 假日班設定會影響可選擇的班次類型</li>
                        <li>• 排班時系統會根據假日設定自動調整班次選項</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 員工可用性設定 Modal -->
    <div id="availabilityModal" class="modal-hidden fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl p-6 relative flex flex-col max-h-[90vh]">
            <button id="closeAvailabilityModalBtn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors">
                <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-2">
                <i data-lucide="calendar-check" class="w-6 h-6 text-orange-500"></i>員工約班設定
            </h3>
            
            <div class="flex gap-6 mb-6">
                <div class="flex-shrink-0">
                    <label class="block text-sm font-medium text-gray-700 mb-2">選擇員工</label>
                    <select id="availabilityEmployeeSelect" class="w-48 p-3 border rounded-lg">
                        <option value="">請選擇員工</option>
                    </select>
                </div>
                <div class="flex-shrink-0">
                    <label class="block text-sm font-medium text-gray-700 mb-2">選擇月份</label>
                    <div class="flex gap-2">
                        <select id="availabilityYearSelect" class="w-24 p-3 border rounded-lg"></select>
                        <select id="availabilityMonthSelect" class="w-24 p-3 border rounded-lg"></select>
                    </div>
                </div>
                <div class="flex items-end gap-2">
                    <button id="clearAvailabilityBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition-colors">清空</button>
                    <button id="setAllAvailableBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg transition-colors">全部可用</button>
                    <button id="setAllUnavailableBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg transition-colors">全部不可用</button>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto">
                <div id="availabilityCalendarContainer" class="mb-6">
                    <p class="text-gray-500 text-center py-8">請先選擇員工和月份</p>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2 text-gray-700">操作說明</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 點擊日期可切換該日的可用狀態</li>
                        <li>• <span class="text-green-600 font-semibold">綠色</span>：可以上班</li>
                        <li>• <span class="text-red-600 font-semibold">紅色</span>：不可以上班</li>
                        <li>• <span class="text-gray-500 font-semibold">灰色</span>：無限制（預設狀態）</li>
                        <li>• 設定會自動儲存，排班時系統會考慮這些限制</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 排班條件設定 Modal -->
    <div id="conditionsModal" class="modal-hidden fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl p-6 relative flex flex-col max-h-[90vh]">
            <button id="closeConditionsModalBtn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors">
                <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-2">
                <i data-lucide="settings" class="w-6 h-6 text-indigo-500"></i>設定排班條件
            </h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6">
                <!-- 員工規則設定 -->
                <form id="employeeRuleForm" class="bg-gray-50 p-6 rounded-xl">
                    <h4 class="font-semibold mb-4 text-gray-700 flex items-center gap-2">
                        <i data-lucide="user" class="w-4 h-4"></i>員工規則
                    </h4>
                    <div class="space-y-4">
                        <select id="ruleEmployeeSelect" class="w-full p-3 border rounded-lg" required>
                            <option value="">請選擇員工</option>
                        </select>
                        <select id="employeeRuleType" class="w-full p-3 border rounded-lg">
                            <option value="maxConsecutiveWorkDays">最多連續工作天數</option>
                            <option value="no24HourShift">禁止夜班後隔天接白班</option>
                            <option value="noDirectShiftTransition">禁止班次直接銜接</option>
                            <option value="balanceShifts">白班夜班數量平衡</option>
                            <option value="preferredShift">偏好班次設定</option>
                            <option value="maxWeeklyShifts">每週最大班次數</option>
                        </select>
                        <input type="number" id="employeeRuleValue" min="1" max="30" value="5" class="w-full p-3 border rounded-lg" required>
                        <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                            <p id="ruleDescription">請選擇規則類型查看說明</p>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg transition-colors">新增規則</button>
                    </div>
                </form>

                <!-- 班別規則設定 -->
                <form id="shiftRuleForm" class="bg-gray-50 p-6 rounded-xl">
                    <h4 class="font-semibold mb-4 text-gray-700 flex items-center gap-2">
                        <i data-lucide="clock" class="w-4 h-4"></i>班別規則
                    </h4>
                    <div class="space-y-4">
                        <select id="shiftRuleType" class="w-full p-3 border rounded-lg">
                            <option value="day">平日白班 (7:00-15:00)</option>
                            <option value="evening">平日小夜 (15:00-23:00)</option>
                            <option value="night">平日大夜 (23:00-7:00)</option>
                            <option value="weekend-day">週末/假日白班 (7:00-19:00)</option>
                            <option value="weekend-night">週末/假日夜班 (19:00-7:00)</option>
                        </select>
                        <select id="shiftRuleCondition" class="w-full p-3 border rounded-lg">
                            <option value="minStaff">每日最少人數</option>
                            <option value="maxStaff">每日最多人數</option>
                            <option value="preferredStaff">建議人數</option>
                        </select>
                        <input type="number" id="shiftRuleValue" min="0" max="50" value="1" class="w-full p-3 border rounded-lg" required>
                        <div class="text-sm text-gray-600 bg-green-50 p-3 rounded-lg">
                            <p>設定該班別的人力需求限制，系統排班時會遵循這些規則</p>
                        </div>
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg transition-colors">新增規則</button>
                    </div>
                </form>
            </div>

            <!-- 規則列表 -->
            <div class="flex-grow overflow-y-auto">
                <h4 class="font-semibold mb-4 text-gray-700 flex items-center gap-2">
                    <i data-lucide="list" class="w-4 h-4"></i>目前規則列表
                </h4>
                <div id="rulesList" class="space-y-3">
                    <p class="text-gray-500 text-center py-8">尚未設定任何規則</p>
                </div>
            </div>

            <!-- 預設規則快速設定 -->
            <div class="mt-6 pt-4 border-t">
                <h4 class="font-semibold mb-3 text-gray-700">快速設定預設規則</h4>
                <div class="flex flex-wrap gap-2">
                    <button id="setBasicRulesBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                        基本安全規則
                    </button>
                    <button id="setBalancedRulesBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                        平衡排班規則
                    </button>
                    <button id="clearAllRulesBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                        清空所有規則
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 排班 Modal -->
    <div id="shiftModal" class="modal-hidden fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button id="closeShiftModalBtn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors">
                <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
            </button>
            <h3 id="shiftModalTitle" class="text-2xl font-bold text-gray-800 mb-6"></h3>
            <form id="shiftForm">
                <input type="hidden" id="selectedDateInput">
                <input type="hidden" id="editingShiftIndex">
                
                <div class="mb-6">
                    <label for="modalEmployeeSelect" class="block text-sm font-medium text-gray-700 mb-2">選擇員工</label>
                    <select id="modalEmployeeSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></select>
                </div>
                
                <div class="mb-8">
                    <label for="modalShiftTypeSelect" class="block text-sm font-medium text-gray-700 mb-2">選擇班別</label>
                    <select id="modalShiftTypeSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="deleteShiftBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg transition-colors hidden">刪除</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 自動排班 Modal -->
    <div id="autoScheduleModal" class="modal-hidden fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] p-6 relative flex flex-col">
            <button id="closeAutoScheduleModalBtn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors z-10">
                <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-2">
                <i data-lucide="wand-2" class="w-6 h-6 text-violet-500"></i>自動排班設定
            </h3>
            
            <div class="flex-1 overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-xl">
                        <h4 class="font-semibold mb-4 text-gray-700 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-4 h-4"></i>基本設定
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">排班範圍</label>
                                <select id="autoScheduleRange" class="w-full p-3 border rounded-lg">
                                    <option value="currentMonth">本月</option>
                                    <option value="nextMonth">下個月</option>
                                    <option value="both">本月+下個月</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">排班策略</label>
                                <select id="autoScheduleStrategy" class="w-full p-3 border rounded-lg">
                                    <option value="balanced">平衡分配</option>
                                    <option value="minimize_night">減少夜班</option>
                                    <option value="rotate">輪班制</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-emerald-100 p-6 rounded-xl">
                        <h4 class="font-semibold mb-4 text-gray-700 flex items-center gap-2">
                            <i data-lucide="users" class="w-4 h-4"></i>平日人力需求
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">白班人數 (7:00-15:00)</label>
                                <input type="number" id="dayShiftStaff" min="0" max="10" value="1" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">小夜人數 (15:00-23:00)</label>
                                <input type="number" id="eveningShiftStaff" min="0" max="10" value="1" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">大夜人數 (23:00-7:00)</label>
                                <input type="number" id="nightShiftStaff" min="0" max="10" value="1" class="w-full p-3 border rounded-lg">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-purple-50 to-pink-100 p-6 rounded-xl">
                        <h4 class="font-semibold mb-4 text-gray-700 flex items-center gap-2">
                            <i data-lucide="sun" class="w-4 h-4"></i>週末/假日人力需求
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">白班 (7:00-19:00)</label>
                                <input type="number" id="weekendDayShiftStaff" min="0" max="10" value="1" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">夜班 (19:00-7:00)</label>
                                <input type="number" id="weekendNightShiftStaff" min="0" max="10" value="1" class="w-full p-3 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-red-100 p-6 rounded-xl">
                        <h4 class="font-semibold mb-4 text-gray-700 flex items-center gap-2">
                            <i data-lucide="shield" class="w-4 h-4"></i>限制條件
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">最大連續工作天</label>
                                <input type="number" id="maxConsecutiveDays" min="1" max="14" value="5" class="w-full p-3 border rounded-lg">
                            </div>
                            <div class="bg-white p-3 rounded-lg border-l-4 border-orange-400">
                                <p class="text-sm text-gray-600"><strong>班次間隔：</strong>平日班次間需間隔至少兩個班次（如白班後不會直接安排小夜）</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t bg-white sticky bottom-0">
                <button id="clearMonthBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg transition-colors flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>清空本月
                </button>
                <button id="startAutoScheduleBtn" class="bg-violet-500 hover:bg-violet-600 text-white px-6 py-3 rounded-lg transition-colors flex items-center gap-2">
                    <i data-lucide="play" class="w-4 h-4"></i>開始排班
                </button>
            </div>
        </div>
    </div>

    <script src="./scheduling_rules.js"></script>
    <script>
        // 應用初始化
        const initializeApp = () => {
            console.log('開始初始化修訂版排班系統...');
            
            // 獲取所有DOM元素
            const calendarDateGrid = document.getElementById('calendarDateGrid');
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            const monthlyStats = document.getElementById('monthlyStats');
            const employeeNameInput = document.getElementById('employeeNameInput');
            const addEmployeeBtn = document.getElementById('addEmployeeBtn');
            const employeeList = document.getElementById('employeeList');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const importDataInput = document.getElementById('importDataInput');
            
            // Modal 相關元素
            const shiftModal = document.getElementById('shiftModal');
            const closeShiftModalBtn = document.getElementById('closeShiftModalBtn');
            const shiftModalTitle = document.getElementById('shiftModalTitle');
            const shiftForm = document.getElementById('shiftForm');
            const selectedDateInput = document.getElementById('selectedDateInput');
            const editingShiftIndex = document.getElementById('editingShiftIndex');
            const modalEmployeeSelect = document.getElementById('modalEmployeeSelect');
            const modalShiftTypeSelect = document.getElementById('modalShiftTypeSelect');
            const deleteShiftBtn = document.getElementById('deleteShiftBtn');
            
            const conditionsModal = document.getElementById('conditionsModal');
            const openConditionsModalBtn = document.getElementById('openConditionsModalBtn');
            const closeConditionsModalBtn = document.getElementById('closeConditionsModalBtn');
            const employeeRuleForm = document.getElementById('employeeRuleForm');
            const shiftRuleForm = document.getElementById('shiftRuleForm');
            const rulesList = document.getElementById('rulesList');
            const ruleEmployeeSelect = document.getElementById('ruleEmployeeSelect');
            const employeeRuleType = document.getElementById('employeeRuleType');
            const employeeRuleValue = document.getElementById('employeeRuleValue');
            const shiftRuleType = document.getElementById('shiftRuleType');
            const shiftRuleCondition = document.getElementById('shiftRuleCondition');
            const shiftRuleValue = document.getElementById('shiftRuleValue');
            const setBasicRulesBtn = document.getElementById('setBasicRulesBtn');
            const setBalancedRulesBtn = document.getElementById('setBalancedRulesBtn');
            const clearAllRulesBtn = document.getElementById('clearAllRulesBtn');
            
            const autoScheduleModal = document.getElementById('autoScheduleModal');
            const autoScheduleBtn = document.getElementById('autoScheduleBtn');
            const closeAutoScheduleModalBtn = document.getElementById('closeAutoScheduleModalBtn');
            const startAutoScheduleBtn = document.getElementById('startAutoScheduleBtn');
            const clearMonthBtn = document.getElementById('clearMonthBtn');
            const validateScheduleBtn = document.getElementById('validateScheduleBtn');
            const generateReportBtn = document.getElementById('generateReportBtn');

            // 員工可用性相關元素
            const availabilityModal = document.getElementById('availabilityModal');
            const openAvailabilityModalBtn = document.getElementById('openAvailabilityModalBtn');
            const closeAvailabilityModalBtn = document.getElementById('closeAvailabilityModalBtn');
            const availabilityEmployeeSelect = document.getElementById('availabilityEmployeeSelect');
            const availabilityYearSelect = document.getElementById('availabilityYearSelect');
            const availabilityMonthSelect = document.getElementById('availabilityMonthSelect');
            const availabilityCalendarContainer = document.getElementById('availabilityCalendarContainer');
            const clearAvailabilityBtn = document.getElementById('clearAvailabilityBtn');
            const setAllAvailableBtn = document.getElementById('setAllAvailableBtn');
            const setAllUnavailableBtn = document.getElementById('setAllUnavailableBtn');

            // 假日班相關元素
            const holidayModal = document.getElementById('holidayModal');
            const openHolidayModalBtn = document.getElementById('openHolidayModalBtn');
            const closeHolidayModalBtn = document.getElementById('closeHolidayModalBtn');
            const holidayYearSelect = document.getElementById('holidayYearSelect');
            const holidayMonthSelect = document.getElementById('holidayMonthSelect');
            const holidayCalendarContainer = document.getElementById('holidayCalendarContainer');
            const clearHolidaysBtn = document.getElementById('clearHolidaysBtn');
            const setWeekendsHolidayBtn = document.getElementById('setWeekendsHolidayBtn');

            // 全域變數
            let currentDate = new Date();
            let employees = [];
            let scheduleData = {};
            let employeeAvailability = {};
            let holidayDates = {};
            let schedulingConditions = { employeeRules: [], shiftRules: [] };
            
            // 更新班次類型定義 - 修訂版時間
            const shiftTypes = {
                // 平日三班制 (週一至週五)
                day: '平日白班 (7:00-15:00)',
                evening: '平日小夜 (15:00-23:00)', 
                night: '平日大夜 (23:00-7:00)',
                // 週末及假日兩班制 (週六、週日及假日)
                'weekend-day': '週末/假日白班 (7:00-19:00)',
                'weekend-night': '週末/假日夜班 (19:00-7:00)',
                // 休假
                off: '休假'
            };

            // 錯誤處理和通知系統
            const showNotification = (message, type = 'info', duration = 5000) => {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">&times;</button>
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            };

            // 輔助函數
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const isToday = (date) => formatDate(date) === formatDate(new Date());

            const isHoliday = (dateStr) => {
                return holidayDates[dateStr] === true;
            };

            const isWeekend = (dateStr) => {
                const date = new Date(dateStr);
                const dayOfWeek = date.getDay();
                return dayOfWeek === 0 || dayOfWeek === 6; // 0=星期日, 6=星期六
            };

            const isWeekendOrHoliday = (dateStr) => {
                return isWeekend(dateStr) || isHoliday(dateStr);
            };

            const hasUnavailableEmployees = (dateStr) => {
                return Object.values(employeeAvailability).some(availability => 
                    availability[dateStr] === false
                );
            };

            const getAvailableShiftTypes = (dateStr) => {
                if (isWeekendOrHoliday(dateStr)) {
                    return {
                        'weekend-day': shiftTypes['weekend-day'],
                        'weekend-night': shiftTypes['weekend-night'],
                        'off': shiftTypes['off']
                    };
                } else {
                    return {
                        'day': shiftTypes['day'],
                        'evening': shiftTypes['evening'],
                        'night': shiftTypes['night'],
                        'off': shiftTypes['off']
                    };
                }
            };

            // 資料管理函數
            const loadData = () => {
                try {
                    const storedEmployees = localStorage.getItem('scheduler_employees_v2');
                    if (storedEmployees) employees = JSON.parse(storedEmployees);
                    
                    const storedSchedule = localStorage.getItem('scheduler_data_v2');
                    if (storedSchedule) scheduleData = JSON.parse(storedSchedule);
                    
                    const storedAvailability = localStorage.getItem('scheduler_availability_v2');
                    if (storedAvailability) {
                        employeeAvailability = JSON.parse(storedAvailability);
                    }
                    
                    const storedHolidays = localStorage.getItem('scheduler_holidays_v2');
                    if (storedHolidays) {
                        holidayDates = JSON.parse(storedHolidays);
                    }
                    
                    const storedConditions = localStorage.getItem('scheduler_conditions_v2');
                    if (storedConditions) {
                        const parsedConditions = JSON.parse(storedConditions);
                        if (parsedConditions && parsedConditions.employeeRules && parsedConditions.shiftRules) {
                            schedulingConditions = parsedConditions;
                        }
                    }
                    
                    console.log('資料載入成功');
                } catch (error) {
                    console.error('從 localStorage 載入資料失敗，將使用預設值:', error);
                    showNotification('載入資料失敗，使用預設設定', 'warning');
                    employees = [];
                    scheduleData = {};
                    employeeAvailability = {};
                    holidayDates = {};
                    schedulingConditions = { employeeRules: [], shiftRules: [] };
                }
            };
            
            const saveData = () => {
                try {
                    localStorage.setItem('scheduler_employees_v2', JSON.stringify(employees));
                    localStorage.setItem('scheduler_data_v2', JSON.stringify(scheduleData));
                    localStorage.setItem('scheduler_availability_v2', JSON.stringify(employeeAvailability));
                    localStorage.setItem('scheduler_holidays_v2', JSON.stringify(holidayDates));
                    localStorage.setItem('scheduler_conditions_v2', JSON.stringify(schedulingConditions));
                    console.log('資料儲存成功');
                } catch (error) {
                    console.error('儲存資料到 localStorage 失敗:', error);
                    showNotification('儲存資料失敗', 'error');
                }
            };

            // Modal 控制函數
            const openModal = (modalEl) => { 
                modalEl.classList.remove('modal-hidden'); 
                modalEl.classList.add('modal-visible'); 
                document.body.style.overflow = 'hidden'; 
            };
            
            const closeModal = (modalEl) => { 
                modalEl.classList.remove('modal-visible'); 
                modalEl.classList.add('modal-hidden'); 
                document.body.style.overflow = ''; 
            };

            // 渲染排班條件規則列表
            const renderRulesList = () => {
                if (!rulesList) {
                    console.error('找不到 rulesList 元素');
                    return;
                }

                rulesList.innerHTML = '';
                
                if (schedulingConditions.employeeRules.length === 0 && schedulingConditions.shiftRules.length === 0) {
                    rulesList.innerHTML = '<p class="text-gray-500 text-center py-8">尚未設定任何規則</p>';
                    return;
                }

                // 員工規則
                if (schedulingConditions.employeeRules.length > 0) {
                    const employeeRulesSection = document.createElement('div');
                    employeeRulesSection.className = 'mb-6';
                    employeeRulesSection.innerHTML = '<h5 class="font-semibold text-gray-700 mb-3">員工規則</h5>';
                    
                    schedulingConditions.employeeRules.forEach((rule, index) => {
                        const ruleDiv = document.createElement('div');
                        ruleDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 mb-2 flex items-center justify-between';
                        
                        let ruleText = '';
                        switch (rule.type) {
                            case 'maxConsecutiveWorkDays':
                                ruleText = `${rule.employee} - 最多連續工作 ${rule.value} 天`;
                                break;
                            case 'no24HourShift':
                                ruleText = `${rule.employee} - 禁止24小時連續工作`;
                                break;
                            case 'noDirectShiftTransition':
                                ruleText = `${rule.employee} - 禁止班次直接銜接`;
                                break;
                            case 'balanceShifts':
                                ruleText = `${rule.employee} - 白班夜班平衡（差距不超過 ${rule.value}）`;
                                break;
                            case 'preferredShift':
                                ruleText = `${rule.employee} - 偏好班次設定`;
                                break;
                            case 'maxWeeklyShifts':
                                ruleText = `${rule.employee} - 每週最多 ${rule.value} 班`;
                                break;
                        }
                        
                        ruleDiv.innerHTML = `
                            <span class="text-sm text-gray-700">${ruleText}</span>
                            <button class="delete-employee-rule-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition-colors" data-index="${index}">
                                刪除
                            </button>
                        `;
                        employeeRulesSection.appendChild(ruleDiv);
                    });
                    
                    rulesList.appendChild(employeeRulesSection);
                }

                // 班別規則
                if (schedulingConditions.shiftRules.length > 0) {
                    const shiftRulesSection = document.createElement('div');
                    shiftRulesSection.innerHTML = '<h5 class="font-semibold text-gray-700 mb-3">班別規則</h5>';
                    
                    schedulingConditions.shiftRules.forEach((rule, index) => {
                        const ruleDiv = document.createElement('div');
                        ruleDiv.className = 'bg-green-50 border border-green-200 rounded-lg p-3 mb-2 flex items-center justify-between';
                        
                        const shiftName = shiftTypes[rule.shift] || rule.shift;
                        let conditionText = '';
                        switch (rule.type) {
                            case 'minStaff':
                                conditionText = `最少 ${rule.value} 人`;
                                break;
                            case 'maxStaff':
                                conditionText = `最多 ${rule.value} 人`;
                                break;
                            case 'preferredStaff':
                                conditionText = `建議 ${rule.value} 人`;
                                break;
                        }
                        
                        ruleDiv.innerHTML = `
                            <span class="text-sm text-gray-700">${shiftName} - ${conditionText}</span>
                            <button class="delete-shift-rule-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition-colors" data-index="${index}">
                                刪除
                            </button>
                        `;
                        shiftRulesSection.appendChild(ruleDiv);
                    });
                    
                    rulesList.appendChild(shiftRulesSection);
                }
            };

            // 更新規則說明
            const updateRuleDescription = () => {
                if (!employeeRuleType) {
                    console.error('找不到 employeeRuleType 元素');
                    return;
                }

                const ruleType = employeeRuleType.value;
                const descriptionEl = document.getElementById('ruleDescription');
                
                if (!descriptionEl) {
                    console.error('找不到 ruleDescription 元素');
                    return;
                }
                
                const descriptions = {
                    'maxConsecutiveWorkDays': '設定員工最多可連續工作的天數，避免過度疲勞',
                    'no24HourShift': '禁止員工在夜班後隔天直接上白班，確保充分休息',
                    'noDirectShiftTransition': '禁止班次直接銜接（如白班→小夜），需間隔至少兩個班次',
                    'balanceShifts': '平衡員工的白班與夜班數量，設定允許的最大差距',
                    'preferredShift': '設定員工偏好的班次類型',
                    'maxWeeklyShifts': '限制員工每週最多上班次數'
                };
                
                descriptionEl.textContent = descriptions[ruleType] || '請選擇規則類型查看說明';
            };

            // 日期選擇器填充
            const populateDateSelectors = () => {
                const selectedYear = currentDate.getFullYear();
                const selectedMonth = currentDate.getMonth() + 1;
                
                yearSelect.innerHTML = '';
                for (let i = selectedYear - 5; i <= selectedYear + 5; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i} 年`;
                    option.style.color = '#374151';
                    yearSelect.appendChild(option);
                }
                
                monthSelect.innerHTML = '';
                const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = monthNames[i-1];
                    option.style.color = '#374151';
                    monthSelect.appendChild(option);
                }
                
                yearSelect.value = selectedYear;
                monthSelect.value = selectedMonth;
            };

            const populateAvailabilitySelectors = () => {
                const currentYear = new Date().getFullYear();
                
                availabilityYearSelect.innerHTML = '';
                for (let i = currentYear - 1; i <= currentYear + 2; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    option.style.color = '#374151';
                    availabilityYearSelect.appendChild(option);
                }
                
                availabilityMonthSelect.innerHTML = '';
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}月`;
                    option.style.color = '#374151';
                    availabilityMonthSelect.appendChild(option);
                }

                availabilityYearSelect.value = currentYear;
                availabilityMonthSelect.value = new Date().getMonth() + 1;
            };

            const populateHolidaySelectors = () => {
                const currentYear = new Date().getFullYear();
                
                holidayYearSelect.innerHTML = '';
                for (let i = currentYear - 1; i <= currentYear + 2; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    option.style.color = '#374151';
                    holidayYearSelect.appendChild(option);
                }
                
                holidayMonthSelect.innerHTML = '';
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}月`;
                    option.style.color = '#374151';
                    holidayMonthSelect.appendChild(option);
                }

                holidayYearSelect.value = currentYear;
                holidayMonthSelect.value = new Date().getMonth() + 1;
            };

            // 月份統計更新
            const updateMonthlyStats = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let totalShifts = 0;
                let workingDays = 0;
                let holidayCount = 0;
                let weekendCount = 0;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(new Date(year, month, day));
                    const shifts = scheduleData[dateStr] || [];
                    if (shifts.length > 0) {
                        workingDays++;
                        totalShifts += shifts.length;
                    }
                    if (isHoliday(dateStr)) {
                        holidayCount++;
                    }
                    if (isWeekend(dateStr)) {
                        weekendCount++;
                    }
                }
                monthlyStats.innerHTML = `本月統計：${workingDays} 個工作日，共 ${totalShifts} 個班次 | 假日：${holidayCount} 天，週末：${weekendCount} 天`;
            };

            // 渲染日曆
            const renderCalendar = () => {
                populateDateSelectors();
                updateMonthlyStats();
                calendarDateGrid.innerHTML = '';
                
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevYear = month === 0 ? year - 1 : year;
                const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();
                
                // 上個月的日期
                for (let i = firstDayOfMonth - 1; i >= 0; i--) {
                    const day = daysInPrevMonth - i;
                    const cell = document.createElement('div');
                    cell.className = 'other-month-cell p-2 relative flex flex-col';
                    cell.innerHTML = `<div class="date-number text-gray-400">${day}</div><div class="mt-2 space-y-1 overflow-y-auto flex-grow"></div>`;
                    calendarDateGrid.appendChild(cell);
                }
                
                // 本月的日期
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = formatDate(date);
                    const cell = document.createElement('div');
                    cell.className = 'date-cell p-2 cursor-pointer relative flex flex-col';
                    
                    if (isToday(date)) cell.classList.add('today-cell');
                    if (isHoliday(dateStr)) cell.classList.add('holiday-cell');
                    if (isWeekend(dateStr) && !isHoliday(dateStr)) cell.classList.add('weekend-cell');
                    
                    if (hasUnavailableEmployees(dateStr)) {
                        cell.classList.add('unavailable-cell');
                        const unavailableIndicator = document.createElement('div');
                        unavailableIndicator.className = 'unavailable-indicator';
                        unavailableIndicator.textContent = '!';
                        unavailableIndicator.title = '有員工此日不可用';
                        cell.appendChild(unavailableIndicator);
                    }
                    
                    if (isHoliday(dateStr)) {
                        const holidayIndicator = document.createElement('div');
                        holidayIndicator.className = 'holiday-indicator';
                        holidayIndicator.textContent = 'H';
                        holidayIndicator.title = '假日班（兩班制）';
                        cell.appendChild(holidayIndicator);
                    }

                    if (isWeekend(dateStr) && !isHoliday(dateStr)) {
                        const weekendIndicator = document.createElement('div');
                        weekendIndicator.className = 'weekend-indicator';
                        weekendIndicator.textContent = 'W';
                        weekendIndicator.title = '週末（兩班制）';
                        cell.appendChild(weekendIndicator);
                    }
                    
                    cell.dataset.date = dateStr;
                    const dateNumber = document.createElement('div');
                    dateNumber.className = 'date-number text-gray-700 font-semibold';
                    if (isToday(date)) dateNumber.classList.add('today-number', 'text-white');
                    if (isHoliday(dateStr) && !isToday(date)) dateNumber.classList.add('holiday-number', 'text-white');
                    if (isWeekend(dateStr) && !isHoliday(dateStr) && !isToday(date)) dateNumber.classList.add('weekend-number', 'text-white');
                    dateNumber.textContent = day;
                    
                    const shiftsContainer = document.createElement('div');
                    shiftsContainer.className = 'mt-2 space-y-1 overflow-y-auto flex-grow';
                    const shifts = scheduleData[dateStr] || [];
                    shifts.forEach((shift, index) => {
                        const shiftEl = document.createElement('div');
                        shiftEl.className = `shift-item shift-color-${shift.shift}`;
                        shiftEl.textContent = `${shift.employee}`;
                        shiftEl.dataset.index = index;
                        shiftEl.title = `${shift.employee}: ${shiftTypes[shift.shift]}`;
                        shiftsContainer.appendChild(shiftEl);
                    });
                    
                    cell.appendChild(dateNumber);
                    cell.appendChild(shiftsContainer);
                    calendarDateGrid.appendChild(cell);
                }
                
                // 下個月的日期
                const totalCells = firstDayOfMonth + daysInMonth;
                const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells;
                for (let day = 1; day <= remainingCells; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'other-month-cell p-2 relative flex flex-col';
                    cell.innerHTML = `<div class="date-number text-gray-400">${day}</div><div class="mt-2 space-y-1 overflow-y-auto flex-grow"></div>`;
                    calendarDateGrid.appendChild(cell);
                }
            };

            // 渲染員工列表
            const renderEmployees = () => {
                employeeList.innerHTML = '';
                availabilityEmployeeSelect.innerHTML = '<option value="">請選擇員工</option>';
                ruleEmployeeSelect.innerHTML = '<option value="">請選擇員工</option>';
                
                if (employees.length === 0) {
                    employeeList.innerHTML = '<p class="text-white/70 text-sm text-center py-4">尚未新增任何員工</p>';
                } else {
                    employees.forEach((name, index) => {
                        const employeeDiv = document.createElement('div');
                        employeeDiv.className = 'employee-card flex items-center justify-between';
                        employeeDiv.innerHTML = `
                            <span class="text-white font-medium">${name}</span>
                            <div class="flex gap-2">
                                <button class="availability-employee-btn p-1 rounded-full hover:bg-orange-500/30 transition-colors" data-employee="${name}" title="設定可用性">
                                    <i data-lucide="calendar-check" class="w-4 h-4 text-orange-300 pointer-events-none"></i>
                                </button>
                                <button class="delete-employee-btn p-1 rounded-full hover:bg-red-500/30 transition-colors" data-index="${index}">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-red-300 pointer-events-none"></i>
                                </button>
                            </div>
                        `;
                        employeeList.appendChild(employeeDiv);
                        
                        const availOption = document.createElement('option');
                        availOption.value = name;
                        availOption.textContent = name;
                        availOption.style.color = '#374151';
                        availabilityEmployeeSelect.appendChild(availOption);

                        const ruleOption = document.createElement('option');
                        ruleOption.value = name;
                        ruleOption.textContent = name;
                        ruleOption.style.color = '#374151';
                        ruleEmployeeSelect.appendChild(ruleOption);
                    });
                }
                lucide.createIcons();
            };

            // 渲染員工可用性日曆
            const renderAvailabilityCalendar = () => {
                const employee = availabilityEmployeeSelect.value;
                const year = parseInt(availabilityYearSelect.value);
                const month = parseInt(availabilityMonthSelect.value);

                if (!employee || !year || !month) {
                    availabilityCalendarContainer.innerHTML = '<p class="text-gray-500 text-center py-8">請先選擇員工和月份</p>';
                    return;
                }

                const daysInMonth = new Date(year, month, 0).getDate();
                const firstDay = new Date(year, month - 1, 1).getDay();
                
                if (!employeeAvailability[employee]) {
                    employeeAvailability[employee] = {};
                }

                let calendarHTML = `
                    <h4 class="text-lg font-semibold mb-4 text-gray-800">${employee} - ${year}年${month}月 可用性設定</h4>
                    <div class="availability-calendar">
                `;

                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                weekdays.forEach(day => {
                    calendarHTML += `<div class="text-center text-sm font-semibold text-gray-600 p-2">${day}</div>`;
                });

                for (let i = 0; i < firstDay; i++) {
                    calendarHTML += '<div></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const availability = employeeAvailability[employee][dateStr];
                    
                    let className = 'availability-day availability-neutral';
                    let text = day;
                    
                    if (availability === true) {
                        className = 'availability-day availability-available';
                        text = `${day} ✓`;
                    } else if (availability === false) {
                        className = 'availability-day availability-unavailable';
                        text = `${day} ✗`;
                    }
                    
                    calendarHTML += `
                        <div class="${className}" data-date="${dateStr}" data-employee="${employee}">
                            ${text}
                        </div>
                    `;
                }

                calendarHTML += '</div>';
                availabilityCalendarContainer.innerHTML = calendarHTML;
            };

            // 渲染假日設定日曆
            const renderHolidayCalendar = () => {
                const year = parseInt(holidayYearSelect.value);
                const month = parseInt(holidayMonthSelect.value);

                if (!year || !month) {
                    holidayCalendarContainer.innerHTML = '<p class="text-gray-500 text-center py-8">請先選擇月份</p>';
                    return;
                }

                const daysInMonth = new Date(year, month, 0).getDate();
                const firstDay = new Date(year, month - 1, 1).getDay();

                let calendarHTML = `
                    <h4 class="text-lg font-semibold mb-4 text-gray-800">${year}年${month}月 假日班設定</h4>
                    <div class="availability-calendar">
                `;

                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                weekdays.forEach(day => {
                    calendarHTML += `<div class="text-center text-sm font-semibold text-gray-600 p-2">${day}</div>`;
                });

                for (let i = 0; i < firstDay; i++) {
                    calendarHTML += '<div></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isHolidayDate = isHoliday(dateStr);
                    const isWeekendDate = isWeekend(dateStr);
                    
                    let className = 'availability-day availability-neutral';
                    let text = day;
                    
                    if (isHolidayDate) {
                        className = 'availability-day bg-yellow-200 border-yellow-500 text-yellow-800';
                        text = `${day} H`;
                    } else if (isWeekendDate) {
                        className = 'availability-day bg-blue-100 border-blue-300 text-blue-700';
                        text = `${day} W`;
                    }
                    
                    calendarHTML += `
                        <div class="${className}" data-date="${dateStr}" data-holiday="${isHolidayDate}">
                            ${text}
                        </div>
                    `;
                }

                calendarHTML += '</div>';
                holidayCalendarContainer.innerHTML = calendarHTML;
            };
            
            const autoSchedule = (config) => {
                const {
                    range, strategy, dayStaff, eveningStaff, nightStaff,
                    weekendDayStaff, weekendNightStaff, maxConsecutive, currentDate,
                    employees, scheduleData, employeeAvailability, holidayDates, schedulingConditions
                } = config;
                
                try {
                    const newSchedule = {};
                    const stats = { scheduledDays: 0, dayShifts: 0, eveningShifts: 0, nightShifts: 0, weekendDayShifts: 0, weekendNightShifts: 0, skippedDays: 0, conflicts: 0 };
                    
                    const scheduleDates = [];
                    const addMonthDates = (year, month) => {
                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                        for (let day = 1; day <= daysInMonth; day++) {
                            scheduleDates.push(formatDate(new Date(year, month, day)));
                        }
                    };
                    if (range === 'currentMonth') addMonthDates(currentDate.getFullYear(), currentDate.getMonth());
                    else if (range === 'nextMonth') { const d = new Date(currentDate); d.setMonth(d.getMonth() + 1); addMonthDates(d.getFullYear(), d.getMonth()); }
                    else if (range === 'both') {
                        addMonthDates(currentDate.getFullYear(), currentDate.getMonth());
                        const d = new Date(currentDate); d.setMonth(d.getMonth() + 1); addMonthDates(d.getFullYear(), d.getMonth());
                    }

                    const employeeStats = {};
                    employees.forEach(emp => { employeeStats[emp] = { totalShifts: 0, dayShifts: 0, eveningShifts: 0, nightShifts: 0, weekendDayShifts: 0, weekendNightShifts: 0 }; });

                    Object.values(scheduleData).flat().forEach(shift => {
                        if (employeeStats[shift.employee] && shift.shift !== 'off') {
                            employeeStats[shift.employee].totalShifts++;
                            const shiftKey = `${shift.shift.replace('-', '')}Shifts`;
                            if(employeeStats[shift.employee][shiftKey] !== undefined) employeeStats[shift.employee][shiftKey]++;
                        }
                    });
                    
                    const detailedCanEmployeeWorkCheck = (employee, date, shiftType, currentDaySchedule) => {
                        const combinedSchedule = { ...scheduleData, ...newSchedule };
                        
                        if (employeeAvailability[employee]?.[date] === false) return { canWork: false, reason: '個人設定不可用' };
                        if (currentDaySchedule.some(s => s.employee === employee)) return { canWork: false, reason: '本日已有排班' };
                        
                        if (RuleEngine.calculateConsecutiveWorkDays(employee, date, combinedSchedule) >= maxConsecutive) return { canWork: false, reason: `已達最大連續工作天(${maxConsecutive})` };
                        if (RuleEngine.wouldCause24HourShift(employee, date, shiftType, combinedSchedule, holidayDates)) return { canWork: false, reason: '違反24小時輪班規則' };
                        if (RuleEngine.wouldViolateShiftGap(employee, date, shiftType, combinedSchedule, holidayDates)) return { canWork: false, reason: '違反班次間隔規則' };
                        
                        return { canWork: true, reason: null };
                    };

                    const selectEmployeesForShift = (availableEmployees, shiftType, requiredStaff, date) => {
                        if (typeof RuleEngine !== 'undefined' && RuleEngine.selectEmployeesWithFairness) {
                            return RuleEngine.selectEmployeesWithFairness(availableEmployees, shiftType, requiredStaff, employeeStats, employees, strategy, date);
                        }
                        return [...availableEmployees].sort((a, b) => (employeeStats[a]?.totalShifts || 0) - (employeeStats[b]?.totalShifts || 0)).slice(0, requiredStaff);
                    };

                    scheduleDates.forEach(date => {
                        if (scheduleData[date]?.length > 0) {
                            stats.skippedDays++;
                            return;
                        }

                        const isHolidayDate = isWeekendOrHoliday(date);
                        const shiftsToSchedule = [];
                        
                        const scheduleShiftType = (shift, requiredStaff) => {
                            if (requiredStaff > 0) {
                                const alreadyAssigned = shiftsToSchedule.map(s => s.employee);
                                const potentialEmployees = employees.filter(emp => !alreadyAssigned.includes(emp));
                                
                                const availableEmployees = [];
                                potentialEmployees.forEach(emp => {
                                    const check = detailedCanEmployeeWorkCheck(emp, date, shift, shiftsToSchedule);
                                    if(check.canWork) {
                                        availableEmployees.push(emp);
                                    }
                                });

                                const selected = selectEmployeesForShift(availableEmployees, shift, requiredStaff, date);
                                
                                selected.forEach(emp => {
                                    shiftsToSchedule.push({ employee: emp, shift: shift });
                                    employeeStats[emp].totalShifts++;
                                    const shiftKey = `${shift.replace('-', '')}Shifts`;
                                    if(employeeStats[emp][shiftKey] !== undefined) employeeStats[emp][shiftKey]++;
                                    stats[shiftKey] = (stats[shiftKey] || 0) + 1;
                                });
                            }
                        };
                        
                        if (isHolidayDate) {
                            scheduleShiftType('weekend-day', weekendDayStaff);
                            scheduleShiftType('weekend-night', weekendNightStaff);
                        } else {
                            scheduleShiftType('day', dayStaff);
                            scheduleShiftType('evening', eveningStaff);
                            scheduleShiftType('night', nightStaff);
                        }
                        
                        if (shiftsToSchedule.length > 0) {
                            newSchedule[date] = shiftsToSchedule;
                            stats.scheduledDays++;
                        } else {
                            stats.skippedDays++;
                        }
                    });
                    
                    return { success: true, newSchedule, stats };

                } catch (error) {
                    console.error('自動排班過程發生錯誤:', error);
                    return { success: false, error: error.message || '未知錯誤' };
                }
            };

            // 事件監聽器設定
            const setupEventListeners = () => {
                // 排班條件設定事件
                openConditionsModalBtn.addEventListener('click', () => {
                    renderRulesList();
                    updateRuleDescription();
                    openModal(conditionsModal);
                });
                
                closeConditionsModalBtn.addEventListener('click', () => closeModal(conditionsModal));
                conditionsModal.addEventListener('click', (e) => { if (e.target === conditionsModal) closeModal(conditionsModal); });
                employeeRuleType.addEventListener('change', updateRuleDescription);

                employeeRuleForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const employee = ruleEmployeeSelect?.value;
                    const ruleType = employeeRuleType?.value;
                    const value = parseInt(employeeRuleValue?.value);
                    if (!employee) { showNotification('請選擇員工', 'warning'); return; }
                    if (!ruleType) { showNotification('請選擇規則類型', 'warning'); return; }
                    if (isNaN(value) || value < 1) { showNotification('請輸入有效的數值', 'warning'); return; }
                    const existingRule = schedulingConditions.employeeRules.find(r => r.employee === employee && r.type === ruleType);
                    if (existingRule) {
                        if (confirm('該員工已有相同類型的規則，是否要覆蓋？')) { existingRule.value = value; } else { return; }
                    } else {
                        schedulingConditions.employeeRules.push({ employee, type: ruleType, value });
                    }
                    saveData();
                    renderRulesList();
                    employeeRuleForm.reset();
                    updateRuleDescription();
                    showNotification('員工規則已新增', 'success');
                });

                shiftRuleForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const shift = shiftRuleType?.value;
                    const type = shiftRuleCondition?.value;
                    const value = parseInt(shiftRuleValue?.value);
                    if (!shift || !type) { showNotification('請選擇班別和條件類型', 'warning'); return; }
                    if (isNaN(value) || value < 0) { showNotification('請輸入有效的數值', 'warning'); return; }
                    const existingRule = schedulingConditions.shiftRules.find(r => r.shift === shift && r.type === type);
                    if (existingRule) {
                        if (confirm('該班別已有相同類型的規則，是否要覆蓋？')) { existingRule.value = value; } else { return; }
                    } else {
                        schedulingConditions.shiftRules.push({ shift, type, value });
                    }
                    saveData();
                    renderRulesList();
                    shiftRuleForm.reset();
                    showNotification('班別規則已新增', 'success');
                });

                rulesList.addEventListener('click', (e) => {
                    const deleteEmployeeRuleBtn = e.target.closest('.delete-employee-rule-btn');
                    const deleteShiftRuleBtn = e.target.closest('.delete-shift-rule-btn');
                    if (deleteEmployeeRuleBtn) {
                        const index = parseInt(deleteEmployeeRuleBtn.dataset.index);
                        if (confirm('確定要刪除這個員工規則嗎？')) {
                            schedulingConditions.employeeRules.splice(index, 1);
                            saveData();
                            renderRulesList();
                            showNotification('員工規則已刪除', 'success');
                        }
                    }
                    if (deleteShiftRuleBtn) {
                        const index = parseInt(deleteShiftRuleBtn.dataset.index);
                        if (confirm('確定要刪除這個班別規則嗎？')) {
                            schedulingConditions.shiftRules.splice(index, 1);
                            saveData();
                            renderRulesList();
                            showNotification('班別規則已刪除', 'success');
                        }
                    }
                });

                setBasicRulesBtn.addEventListener('click', () => {
                    if (employees.length === 0) { showNotification('請先新增員工', 'warning'); return; }
                    employees.forEach(employee => {
                        if (!schedulingConditions.employeeRules.find(r => r.employee === employee && r.type === 'maxConsecutiveWorkDays')) {
                            schedulingConditions.employeeRules.push({ employee, type: 'maxConsecutiveWorkDays', value: 5 });
                        }
                        if (!schedulingConditions.employeeRules.find(r => r.employee === employee && r.type === 'no24HourShift')) {
                            schedulingConditions.employeeRules.push({ employee, type: 'no24HourShift', value: 1 });
                        }
                    });
                    saveData();
                    renderRulesList();
                    showNotification('基本安全規則已設定', 'success');
                });

                setBalancedRulesBtn.addEventListener('click', () => {
                    if (employees.length === 0) { showNotification('請先新增員工', 'warning'); return; }
                    employees.forEach(employee => {
                        if (!schedulingConditions.employeeRules.find(r => r.employee === employee && r.type === 'balanceShifts')) {
                            schedulingConditions.employeeRules.push({ employee, type: 'balanceShifts', value: 2 });
                        }
                    });
                    saveData();
                    renderRulesList();
                    showNotification('平衡排班規則已設定', 'success');
                });

                clearAllRulesBtn.addEventListener('click', () => {
                    if (confirm('確定要清空所有排班規則嗎？\n\n此操作無法復原！')) {
                        schedulingConditions.employeeRules = [];
                        schedulingConditions.shiftRules = [];
                        saveData();
                        renderRulesList();
                        showNotification('所有規則已清空', 'success');
                    }
                });

                // 其他事件監聽器
                yearSelect.addEventListener('change', () => {
                    const newYear = parseInt(yearSelect.value);
                    const newMonth = parseInt(monthSelect.value) - 1;
                    currentDate = new Date(newYear, newMonth, 1);
                    renderCalendar();
                });
                
                monthSelect.addEventListener('change', () => {
                    const newYear = parseInt(yearSelect.value);
                    const newMonth = parseInt(monthSelect.value) - 1;
                    currentDate = new Date(newYear, newMonth, 1);
                    renderCalendar();
                });
                
                prevMonthBtn.addEventListener('click', () => { 
                    currentDate.setMonth(currentDate.getMonth() - 1); 
                    renderCalendar(); 
                });
                
                nextMonthBtn.addEventListener('click', () => { 
                    currentDate.setMonth(currentDate.getMonth() + 1); 
                    renderCalendar(); 
                });

                addEmployeeBtn.addEventListener('click', () => {
                    const name = employeeNameInput.value.trim();
                    if (name && !employees.includes(name)) {
                        employees.push(name);
                        saveData();
                        renderEmployees();
                        employeeNameInput.value = '';
                        showNotification(`成功新增員工 "${name}"`, 'success');
                    } else if (employees.includes(name)) {
                        showNotification('員工姓名已存在！', 'warning');
                    } else {
                        showNotification('請輸入員工姓名', 'warning');
                    }
                });
                
                employeeNameInput.addEventListener('keypress', (e) => { 
                    if (e.key === 'Enter') addEmployeeBtn.click(); 
                });

                employeeList.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-employee-btn');
                    const availabilityBtn = e.target.closest('.availability-employee-btn');
                    
                    if (deleteBtn) {
                        const index = parseInt(deleteBtn.dataset.index);
                        const nameToDelete = employees[index];
                        if (confirm(`確定要刪除員工 "${nameToDelete}" 嗎？\n這將移除所有相關的班次與可用性設定。`)) {
                            employees.splice(index, 1);
                            Object.keys(scheduleData).forEach(date => {
                                scheduleData[date] = scheduleData[date].filter(s => s.employee !== nameToDelete);
                                if (scheduleData[date].length === 0) delete scheduleData[date];
                            });
                            delete employeeAvailability[nameToDelete];
                            schedulingConditions.employeeRules = schedulingConditions.employeeRules.filter(r => r.employee !== nameToDelete);
                            saveData();
                            renderEmployees();
                            renderCalendar();
                            renderRulesList();
                            showNotification(`已刪除員工 "${nameToDelete}"`, 'success');
                        }
                    }
                    
                    if (availabilityBtn) {
                        const employee = availabilityBtn.dataset.employee;
                        availabilityEmployeeSelect.value = employee;
                        populateAvailabilitySelectors();
                        renderAvailabilityCalendar();
                        openModal(availabilityModal);
                    }
                });

                openHolidayModalBtn.addEventListener('click', () => {
                    populateHolidaySelectors();
                    renderHolidayCalendar();
                    openModal(holidayModal);
                });
                
                closeHolidayModalBtn.addEventListener('click', () => closeModal(holidayModal));
                holidayModal.addEventListener('click', (e) => { if (e.target === holidayModal) closeModal(holidayModal); });

                holidayYearSelect.addEventListener('change', renderHolidayCalendar);
                holidayMonthSelect.addEventListener('change', renderHolidayCalendar);

                holidayCalendarContainer.addEventListener('click', (e) => {
                    const dayEl = e.target.closest('.availability-day');
                    if (!dayEl) return;
                    
                    const date = dayEl.dataset.date;
                    const currentIsHoliday = dayEl.dataset.holiday === 'true';
                    
                    if (currentIsHoliday) {
                        delete holidayDates[date];
                        showNotification(`已取消 ${date} 的假日設定`, 'info');
                    } else {
                        holidayDates[date] = true;
                        showNotification(`已設定 ${date} 為假日`, 'success');
                    }
                    
                    saveData();
                    renderHolidayCalendar();
                    renderCalendar();
                });

                clearHolidaysBtn.addEventListener('click', () => {
                    const year = parseInt(holidayYearSelect.value);
                    const month = parseInt(holidayMonthSelect.value);
                    
                    if (!year || !month) return;
                    
                    if (confirm(`確定要清空 ${year}年${month}月 的所有假日設定嗎？`)) {
                        const daysInMonth = new Date(year, month, 0).getDate();
                        let clearedCount = 0;
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            if (holidayDates[dateStr]) {
                                delete holidayDates[dateStr];
                                clearedCount++;
                            }
                        }
                        saveData();
                        renderHolidayCalendar();
                        renderCalendar();
                        showNotification(`已清空 ${clearedCount} 個假日設定`, 'success');
                    }
                });

                setWeekendsHolidayBtn.addEventListener('click', () => {
                    const year = parseInt(holidayYearSelect.value);
                    const month = parseInt(holidayMonthSelect.value);
                    
                    if (!year || !month) return;
                    
                    const daysInMonth = new Date(year, month, 0).getDate();
                    let weekendCount = 0;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month - 1, day);
                        const dayOfWeek = date.getDay();
                        
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            holidayDates[dateStr] = true;
                            weekendCount++;
                        }
                    }
                    
                    saveData();
                    renderHolidayCalendar();
                    renderCalendar();
                    showNotification(`已設定 ${weekendCount} 個週末為假日班`, 'success');
                });

                openAvailabilityModalBtn.addEventListener('click', () => {
                    populateAvailabilitySelectors();
                    renderAvailabilityCalendar();
                    openModal(availabilityModal);
                });
                
                closeAvailabilityModalBtn.addEventListener('click', () => closeModal(availabilityModal));
                availabilityModal.addEventListener('click', (e) => { if (e.target === availabilityModal) closeModal(availabilityModal); });

                availabilityEmployeeSelect.addEventListener('change', renderAvailabilityCalendar);
                availabilityYearSelect.addEventListener('change', renderAvailabilityCalendar);
                availabilityMonthSelect.addEventListener('change', renderAvailabilityCalendar);

                availabilityCalendarContainer.addEventListener('click', (e) => {
                    const dayEl = e.target.closest('.availability-day');
                    if (!dayEl) return;
                    
                    const date = dayEl.dataset.date;
                    const employee = dayEl.dataset.employee;
                    
                    if (!employeeAvailability[employee]) {
                        employeeAvailability[employee] = {};
                    }
                    
                    const current = employeeAvailability[employee][date];
                    let newState;
                    
                    if (current === undefined) {
                        newState = true;
                    } else if (current === true) {
                        newState = false;
                    } else {
                        newState = undefined;
                        delete employeeAvailability[employee][date];
                    }
                    
                    if (newState !== undefined) {
                        employeeAvailability[employee][date] = newState;
                    }
                    
                    saveData();
                    renderAvailabilityCalendar();
                    renderCalendar();
                });

                clearAvailabilityBtn.addEventListener('click', () => {
                    const employee = availabilityEmployeeSelect.value;
                    const year = parseInt(availabilityYearSelect.value);
                    const month = parseInt(availabilityMonthSelect.value);
                    
                    if (!employee || !year || !month) return;
                    
                    if (confirm(`確定要清空 ${employee} 在 ${year}年${month}月 的所有可用性設定嗎？`)) {
                        const daysInMonth = new Date(year, month, 0).getDate();
                        let clearedCount = 0;
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            if (employeeAvailability[employee] && employeeAvailability[employee][dateStr] !== undefined) {
                                delete employeeAvailability[employee][dateStr];
                                clearedCount++;
                            }
                        }
                        saveData();
                        renderAvailabilityCalendar();
                        renderCalendar();
                        showNotification(`已清空 ${clearedCount} 個可用性設定`, 'success');
                    }
                });

                setAllAvailableBtn.addEventListener('click', () => {
                    const employee = availabilityEmployeeSelect.value;
                    const year = parseInt(availabilityYearSelect.value);
                    const month = parseInt(availabilityMonthSelect.value);
                    
                    if (!employee || !year || !month) return;
                    
                    const daysInMonth = new Date(year, month, 0).getDate();
                    if (!employeeAvailability[employee]) {
                        employeeAvailability[employee] = {};
                    }
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        employeeAvailability[employee][dateStr] = true;
                    }
                    
                    saveData();
                    renderAvailabilityCalendar();
                    renderCalendar();
                    showNotification(`已設定 ${employee} 整月可用`, 'success');
                });

                setAllUnavailableBtn.addEventListener('click', () => {
                    const employee = availabilityEmployeeSelect.value;
                    const year = parseInt(availabilityYearSelect.value);
                    const month = parseInt(availabilityMonthSelect.value);
                    
                    if (!employee || !year || !month) return;
                    
                    const daysInMonth = new Date(year, month, 0).getDate();
                    if (!employeeAvailability[employee]) {
                        employeeAvailability[employee] = {};
                    }
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        employeeAvailability[employee][dateStr] = false;
                    }
                    
                    saveData();
                    renderAvailabilityCalendar();
                    renderCalendar();
                    showNotification(`已設定 ${employee} 整月不可用`, 'info');
                });

                calendarDateGrid.addEventListener('click', (e) => {
                    const dateCell = e.target.closest('.date-cell');
                    if (!dateCell) return;
                    
                    const shiftItem = e.target.closest('.shift-item');
                    const date = dateCell.dataset.date;
                    
                    modalEmployeeSelect.innerHTML = '<option value="" disabled selected>請選擇員工</option>';
                    
                    employees.forEach(name => {
                        const isAvailable = !employeeAvailability[name] || employeeAvailability[name][date] !== false;
                        if (isAvailable || (shiftItem && scheduleData[date] && scheduleData[date][parseInt(shiftItem.dataset.index)].employee === name)) {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name + (isAvailable ? '' : ' (不可用)');
                            option.style.color = isAvailable ? '#374151' : '#dc2626';
                            if (!isAvailable) option.disabled = true;
                            modalEmployeeSelect.appendChild(option);
                        }
                    });
                    
                    modalShiftTypeSelect.innerHTML = '';
                    const availableShifts = getAvailableShiftTypes(date);
                    Object.entries(availableShifts).forEach(([shiftKey, shiftName]) => {
                        const option = document.createElement('option');
                        option.value = shiftKey;
                        option.textContent = shiftName;
                        modalShiftTypeSelect.appendChild(option);
                    });
                    
                    if (shiftItem) {
                        const index = parseInt(shiftItem.dataset.index);
                        const shift = scheduleData[date][index];
                        shiftModalTitle.textContent = `${date} - 編輯班次`;
                        selectedDateInput.value = date;
                        editingShiftIndex.value = index;
                        modalEmployeeSelect.value = shift.employee;
                        modalShiftTypeSelect.value = shift.shift;
                        deleteShiftBtn.classList.remove('hidden');
                    } else {
                        shiftModalTitle.textContent = `${date} - 新增班次`;
                        selectedDateInput.value = date;
                        editingShiftIndex.value = '';
                        deleteShiftBtn.classList.add('hidden');
                    }
                    openModal(shiftModal);
                });

                closeShiftModalBtn.addEventListener('click', () => closeModal(shiftModal));
                shiftModal.addEventListener('click', (e) => { if (e.target === shiftModal) closeModal(shiftModal); });
                
                shiftForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const date = selectedDateInput.value;
                    const employee = modalEmployeeSelect.value;
                    if (!employee) { 
                        showNotification('請選擇一位員工！', 'warning'); 
                        return; 
                    }
                    
                    if (employeeAvailability[employee] && employeeAvailability[employee][date] === false) {
                        if (!confirm(`${employee} 在 ${date} 設定為不可用，確定要安排班次嗎？`)) {
                            return;
                        }
                    }
                    
                    const shift = modalShiftTypeSelect.value;
                    const index = editingShiftIndex.value;
                    const newShift = { employee, shift };
                    
                    if (!scheduleData[date]) scheduleData[date] = [];
                    if (index !== '') { 
                        scheduleData[date][index] = newShift; 
                        showNotification('班次已更新', 'success');
                    } else { 
                        scheduleData[date].push(newShift);
                        showNotification('班次已新增', 'success');
                    }
                    saveData();
                    renderCalendar();
                    closeModal(shiftModal);
                });
                
                deleteShiftBtn.addEventListener('click', () => {
                    if (confirm('確定要刪除這個班次嗎？')) {
                        const date = selectedDateInput.value;
                        const index = parseInt(editingShiftIndex.value);
                        scheduleData[date].splice(index, 1);
                        if (scheduleData[date].length === 0) delete scheduleData[date];
                        saveData();
                        renderCalendar();
                        closeModal(shiftModal);
                        showNotification('班次已刪除', 'success');
                    }
                });

                autoScheduleBtn.addEventListener('click', () => {
                    if (employees.length === 0) {
                        showNotification('請先新增員工！', 'warning');
                        return;
                    }
                    openModal(autoScheduleModal);
                });

                closeAutoScheduleModalBtn.addEventListener('click', () => closeModal(autoScheduleModal));
                autoScheduleModal.addEventListener('click', (e) => { if (e.target === autoScheduleModal) closeModal(autoScheduleModal); });

                startAutoScheduleBtn.addEventListener('click', () => {
                    const config = {
                        range: document.getElementById('autoScheduleRange').value,
                        strategy: document.getElementById('autoScheduleStrategy').value,
                        dayStaff: parseInt(document.getElementById('dayShiftStaff').value, 10),
                        eveningStaff: parseInt(document.getElementById('eveningShiftStaff').value, 10),
                        nightStaff: parseInt(document.getElementById('nightShiftStaff').value, 10),
                        weekendDayStaff: parseInt(document.getElementById('weekendDayShiftStaff').value, 10),
                        weekendNightStaff: parseInt(document.getElementById('weekendNightShiftStaff').value, 10),
                        maxConsecutive: parseInt(document.getElementById('maxConsecutiveDays').value, 10),
                        currentDate, employees, scheduleData, employeeAvailability, holidayDates, schedulingConditions
                    };
                    const maxRequired = Math.max(config.dayStaff + config.eveningStaff + config.nightStaff, config.weekendDayStaff + config.weekendNightStaff);
                    if (maxRequired > employees.length) {
                        alert('單日所需人力總數已超過員工總數，請調整人力需求。');
                        return;
                    }
                    if (confirm('確定要開始自動排班嗎？現有排班資料的日期將會被跳過。')) {
                        const result = autoSchedule(config);
                        if (result.success) {
                            Object.assign(scheduleData, result.newSchedule);
                            saveData();
                            renderCalendar();
                            closeModal(autoScheduleModal);
                            alert(`✅ 自動排班完成！\n\n已安排 ${result.stats.scheduledDays} 個工作日，跳過 ${result.stats.skippedDays} 天。\n詳細日誌請見開發者主控台。`);
                        } else {
                            alert(`❌ 自動排班失敗：${result.error}`);
                        }
                    }
                });

                clearMonthBtn.addEventListener('click', () => {                 
                    if (confirm('確定要清空本月所有排班嗎？\n\n⚠️ 此操作無法復原！')) {
                        const year = currentDate.getFullYear(), month = currentDate.getMonth() + 1;
                        const daysInMonth = new Date(year, month, 0).getDate();
                        let clearedCount = 0;
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            if (scheduleData[dateStr]) {
                                clearedCount += scheduleData[dateStr].length;
                                delete scheduleData[dateStr];
                            }
                        }
                        saveData();
                        renderCalendar();
                        closeModal(autoScheduleModal);
                        showNotification(`✅ 本月排班已清空！共清除了 ${clearedCount} 個班次。`, 'success');
                    }
                });

                validateScheduleBtn.addEventListener('click', () => {
                    let conflicts = [];
                    let stats = {
                        totalShifts: 0,
                        employees: employees.length,
                        workingDays: 0,
                        holidays: 0,
                        weekends: 0
                    };

                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = formatDate(new Date(year, month, day));
                        const shifts = scheduleData[dateStr] || [];
                        
                        if (shifts.length > 0) {
                            stats.workingDays++;
                            stats.totalShifts += shifts.length;
                        }
                        
                        if (isHoliday(dateStr)) stats.holidays++;
                        if (isWeekend(dateStr)) stats.weekends++;

                        shifts.forEach(shift => {
                            if (shift.shift !== 'off' && employeeAvailability[shift.employee]?.[dateStr] === false) {
                                conflicts.push(`${dateStr}: ${shift.employee} 在此日設定為不可用`);
                            }
                        });

                        const employeeShifts = {};
                        shifts.forEach(shift => {
                            if (shift.shift !== 'off') {
                                if (!employeeShifts[shift.employee]) employeeShifts[shift.employee] = [];
                                employeeShifts[shift.employee].push(shift.shift);
                            }
                        });
                        
                        Object.entries(employeeShifts).forEach(([employee, empShifts]) => {
                            if (empShifts.length > 1) {
                                conflicts.push(`${dateStr}: ${employee} 在同一天被安排多個班次: ${empShifts.join(', ')}`);
                            }
                        });
                    }

                    const conflictCount = conflicts.length;
                    let report = `📋 排班驗證報告\n\n`;
                    report += `📊 基本統計：\n`;
                    report += `• 員工數量：${stats.employees} 人\n`;
                    report += `• 工作日：${stats.workingDays} 天\n`;
                    report += `• 總班次：${stats.totalShifts} 個\n`;
                    report += `• 假日：${stats.holidays} 天\n`;
                    report += `• 週末：${stats.weekends} 天\n\n`;

                    if (conflictCount === 0) {
                        report += `✅ 太棒了！未發現任何排班衝突。\n\n`;
                        report += `🎯 排班系統功能檢查：\n`;
                        report += `• 平日三班制 (週一至五)\n`;
                        report += `• 週末兩班制 (週六、日)\n`;
                        report += `• 假日兩班制功能\n`;
                        report += `• 員工可用性管理\n`;
                        report += `• 排班條件規則\n`;
                        showNotification('驗證通過！', 'success');
                    } else {
                        report += `⚠️ 發現 ${conflictCount} 個排班衝突：\n\n`;
                        conflicts.slice(0, 10).forEach((conflict, index) => {
                            report += `${index + 1}. ${conflict}\n`;
                        });
                        if (conflictCount > 10) {
                            report += `... 及其他 ${conflictCount - 10} 個衝突`;
                        }
                        showNotification(`發現 ${conflictCount} 個衝突`, 'warning');
                    }

                    alert(report);
                });

                generateReportBtn.addEventListener('click', () => {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const monthName = new Date(year, month).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });
                    
                    let report = `📈 ${monthName} 排班統計報表\n\n`;
                    
                    const employeeStats = {};
                    employees.forEach(emp => {
                        employeeStats[emp] = {
                            total: 0,
                            day: 0,
                            evening: 0,
                            night: 0,
                            weekendDay: 0,
                            weekendNight: 0,
                            off: 0
                        };
                    });

                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    let totalWorkingDays = 0;
                    let totalShifts = 0;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = formatDate(new Date(year, month, day));
                        const shifts = scheduleData[dateStr] || [];
                        
                        if (shifts.length > 0) {
                            totalWorkingDays++;
                            totalShifts += shifts.length;
                        }
                        
                        shifts.forEach(shift => {
                            if (employeeStats[shift.employee]) {
                                employeeStats[shift.employee].total++;
                                if (shift.shift === 'day') employeeStats[shift.employee].day++;
                                else if (shift.shift === 'evening') employeeStats[shift.employee].evening++;
                                else if (shift.shift === 'night') employeeStats[shift.employee].night++;
                                else if (shift.shift === 'weekend-day') employeeStats[shift.employee].weekendDay++;
                                else if (shift.shift === 'weekend-night') employeeStats[shift.employee].weekendNight++;
                                else if (shift.shift === 'off') employeeStats[shift.employee].off++;
                            }
                        });
                    }

                    report += `📊 總覽：\n`;
                    report += `• 工作日：${totalWorkingDays} 天\n`;
                    report += `• 總班次：${totalShifts} 個\n`;
                    report += `• 平均每日班次：${(totalShifts / Math.max(totalWorkingDays, 1)).toFixed(1)} 個\n\n`;

                    report += `👥 員工班次分布：\n`;
                    employees.forEach(emp => {
                        const stat = employeeStats[emp];
                        report += `• ${emp}：總計 ${stat.total} 班\n`;
                        report += `  平日：白班${stat.day} 小夜${stat.evening} 大夜${stat.night}\n`;
                        report += `  週末/假日：白班${stat.weekendDay} 夜班${stat.weekendNight}\n`;
                        if (stat.off > 0) report += `  休假：${stat.off} 天\n`;
                        report += `\n`;
                    });

                    alert(report);
                    showNotification('報表已生成', 'success');
                });

                // 資料管理
                exportDataBtn.addEventListener('click', () => {
                    const dataStr = JSON.stringify({ 
                        employees, 
                        scheduleData, 
                        employeeAvailability,
                        holidayDates,
                        schedulingConditions,
                        version: 'v2',
                        exportDate: new Date().toISOString()
                    }, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `排班資料_修訂版_${new Date().toISOString().slice(0, 10)}.json`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    showNotification('資料已匯出', 'success');
                });
                
                importDataInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (confirm('匯入資料將會覆蓋目前的排班表、條件、可用性設定與假日設定，確定要繼續嗎？')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const data = JSON.parse(event.target.result);
                                if (data.employees && data.scheduleData) {
                                    employees = data.employees;
                                    scheduleData = data.scheduleData;
                                    employeeAvailability = data.employeeAvailability || {};
                                    holidayDates = data.holidayDates || {};
                                    schedulingConditions = data.schedulingConditions || { employeeRules: [], shiftRules: [] };
                                    saveData();
                                    renderAll();
                                    showNotification('✅ 資料匯入成功！', 'success');
                                } else {
                                    showNotification('❌ 檔案格式不正確！', 'error');
                                }
                            } catch (error) {
                                showNotification('❌ 讀取檔案失敗。', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                    e.target.value = '';
                });
                
                console.log('排班條件事件監聽器設定完成');
            };

            // 渲染所有內容
            const renderAll = () => {
                renderCalendar();
                renderEmployees();
                populateAvailabilitySelectors();
                populateHolidaySelectors();
                lucide.createIcons();
            };

            // 初始化流程
            console.log('載入資料...');
            loadData();
            
            console.log('設定事件監聽器...');
            setupEventListeners();
            
            console.log('渲染初始內容...');
            renderAll();
            
            console.log('修訂版排班系統初始化完成！');
            showNotification('排班系統載入完成 - 排班條件功能已啟用', 'success', 4000);
        };

        // 等待 Lucide 圖標庫載入完成
        const waitForLucide = () => {
            if (typeof lucide !== 'undefined') {
                initializeApp();
            } else {
                setTimeout(waitForLucide, 100);
            }
        };

        // 啟動應用
        document.addEventListener('DOMContentLoaded', waitForLucide);
    </script>
</body>
</html>
